valuesFilePath: values.yml
# Template Variables

# Names
{{ $packageName := .Values.metadata.packageName }}
{{ $os := default "linux" .Values.metadata.os }}
{{ $stepType := ternary "PowerShell" "Bash" (eq $os "windows") }}
{{ $gitResName := print $packageName "_git_source" }}
{{ $frogbotScanResName := print $packageName "_frogbot_scan_result" }}
{{ $codeQualityResName := print $packageName "_code_quality_result" }}
{{ $unitTestResName := print $packageName "_unit_test_result" }}
{{ $buildInfoResultResName := print $packageName "_build_result" }}
{{ $buildInfoResName := print $packageName "_build_info" }}
{{ $cronResName := print $packageName "_cron" }}
{{ $pipelineName := print $packageName "_build" }}
{{ $rootDirectory := ternary (print "/" .Values.configurations.sourceDirectory) "" (not (eq "" .Values.configurations.sourceDirectory)) }}

# Build Trigger
{{ $buildTool := default "maven" .Values.configurations.buildTool }}
{{ $isControlsAvailable := default false .Values.controls }}
{{ $isTriggerByAvailable := default false (and $isControlsAvailable .Values.controls.triggerBy) }}
{{ $isGitTriggerEnabled := default false (and $isTriggerByAvailable (eq .Values.controls.triggerBy.sourceRepository true)) }}
{{ $isExternalTriggerAvailable := default false (and $isTriggerByAvailable .Values.controls.triggerBy.externalResources) }}
{{ $isCronTriggerEnabled := default false (and $isTriggerByAvailable .Values.controls.triggerBy.cron (eq .Values.controls.triggerBy.cron.enabled true)) }}
{{ $isWebhookTriggerEnabled := default false (and $isTriggerByAvailable .Values.controls.triggerBy.incomingWebhooks) }}

# Logging
{{ $isDebugLogsEnabled := and $isControlsAvailable .Values.controls.logging (eq true .Values.controls.logging.enableDebug) }}

# Exporting
{{ $isExportingEnabled := and $isControlsAvailable .Values.controls.exporting (eq true .Values.controls.exporting.enabled) }}

# Notifications
{{ $isNotificationsAvailable := default false (and $isControlsAvailable .Values.controls.notifications) }}
{{ $isEmailNotificationsAvailable := default false (and $isNotificationsAvailable .Values.controls.notifications.email) }}
{{ $isSlackNotificationsAvailable := default false (and $isNotificationsAvailable .Values.controls.notifications.slack) }}

# -----------------------------------------------------------------
# Reusable templates
# These are resolved using 'template' thus indentation is important
# -----------------------------------------------------------------
{{ $templateParams := dict "values" .Values "gitResName" $gitResName "rootDirectory" $rootDirectory "buildTool" $buildTool "stepType" $stepType }}

# Git repo resource
{{ define "res.gitRepo.config" }}
  {{ range $key, $value := .Values.inputs.sourceRepository }}
  {{ $isObject := or (eq $key "files") (eq $key "branches") (eq $key "pullRequestSourceBranches") (eq $key "pullRequestTargetBranches") (eq $key "tags") (eq $key "buildOn") (eq $key "cancelPendingRunsOn") (eq $key "pin") }}
  {{ if (eq $isObject false )}}
      {{ $key }}: {{ $value }}
  {{ else }}
      {{ $key }}:
  {{ range $depthKey, $depthValue := $value }}
        {{ $depthKey }}: {{ $depthValue }}
  {{ end }}
  {{ end }}
  {{ end }}
{{ end }}

# Steps shared template
{{ define "step.shared.onExecute.command" }}
  {{ $ := . }}
  {{ $default := ternary $.defaultGradle $.defaultMvn (eq $.buildTool "gradle") }}
            {{ if $.conf }}
            {{- range $cmd := $.conf.commands }}
            - {{ $cmd }}
            {{- end }}
            {{ else if (or (eq "maven" $.buildTool) (eq "gradle" $.buildTool)) }}
            - {{ $default }}
            {{ end }}
{{ end }}

# frogbot step
{{ define "step.frogbot.onExecute" }}
  {{ $stepType := get . "stepType" }}
  {{ if eq $stepType "PowerShell" }}
            - Write-Output "Executing Frogbot scan..."
  {{ else }}
            - echo "Executing Frogbot scan..."
  {{ end }}
{{ end }}

# code quality step
{{ define "step.codeQuality.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.codeQuality }}
  {{ $ := set $ "defaultMvn" "mvn clean sonar:sonar" }}
  {{ $ := set $ "defaultGradle" "gradle clean sonar" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}{{ $.rootDirectory }}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

# unit test step
{{ define "step.test.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.test }}
  {{ $ := set $ "defaultMvn" "mvn clean test" }}
  {{ $ := set $ "defaultGradle" "gradle clean test" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}{{ $.rootDirectory }}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

# lint step
{{ define "step.lint.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.lint }}
  {{ $ := set $ "defaultMvn" "mvn clean checkstyle:checkstyle" }}
  {{ $ := set $ "defaultGradle" "gradle clean lint" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}{{ $.rootDirectory }}
            {{ template "step.shared.onExecute.command" $ }}
            # TODO: Fix windows command
            - cp -r * ${shared_workspace}
{{ end }}

# build step
{{ define "step.build.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.build }}
  {{ $ := set $ "defaultMvn" "mvn -Dmaven.test.skip=true install" }}
  {{ $ := set $ "defaultGradle" "gradle clean build -x test" }}
            # TODO: Fix windows command
            - cd ${shared_workspace}{{ $.rootDirectory }}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

# publish step
{{ define "step.publish.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.publish }}
  {{ $ := set $ "defaultMvn" "mvn deploy" }}
  {{ $ := set $ "defaultGradle" "gradle deploy" }}
            # TODO: Fix windows command
            - cd ${shared_workspace}{{ $.rootDirectory }}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}
# -----------------------------------------------------------------

# Resource definitions
resources:
  - name: {{ $gitResName }}
    type: GitRepo
    configuration:
      {{ template "res.gitRepo.config" . }}

  - name: {{ $frogbotScanResName }}
    type: PropertyBag
    configuration:
      timestamp: ''
      reportUrl: ''

  - name: {{ $codeQualityResName }}
    type: PropertyBag
    configuration:
      timestamp: ''
      reportUrl: ''

  - name: {{ $unitTestResName }}
    type: PropertyBag
    configuration:
      timestamp: ''
      status: ''

  - name: {{ $buildInfoResultResName }}
    type: PropertyBag
    configuration:
      timestamp: ''
      lintStatus: ''
      buildStatus: ''
      publishStatus: ''

  - name: {{ $buildInfoResName }}
    type: BuildInfo
    configuration:
      sourceArtifactory: myArt
      buildName: java_test_app
      buildNumber: ${run_id}

  {{ if $isCronTriggerEnabled }}
  - name: {{ $cronResName }}
    type: CronTrigger
    configuration:
      interval: '{{ .Values.controls.triggerBy.cron.expression }}'
  {{ end }}

  {{ if $isWebhookTriggerEnabled }}
  {{- range $webhook := .Values.controls.triggerBy.incomingWebhooks }}
  - name: "{{ $packageName }}_webhook_{{ $webhook.webhookName }}"
    type: IncomingWebhook
    configuration:
      webhookName: {{ $webhook.webhookName }}
  {{ end }}
  {{ end }}

# Pipeline definition
pipelines:
  - name: {{ $pipelineName }}
    configuration:
      runtime:
        type: image
        image:
          {{ if .Values.metadata.runtime }}
          custom:
          {{ range $key, $value := .Values.metadata.runtime }}
            {{ $key }}: {{ $value }}
          {{ end }}
          {{ else }}
          auto:
            language: java
            versions:
              - "17"
          {{ end }}
      integrations:
        - name: {{ .Values.inputs.integrations.artifactoryToken }}
        {{ if $isEmailNotificationsAvailable}}
        - name: {{ .Values.controls.notifications.email.integrationName }}
        {{ end }}
        {{ if $isSlackNotificationsAvailable }}
        - name: {{ .Values.controls.notifications.slack.integrationName }}
        {{ end }}

      # Setting nodePool
      {{ if .Values.metadata.nodePool }}
      nodePool: {{ .Values.metadata.nodePool }}
      {{ end }}

      environmentVariables:
        readOnly:
          ENABLE_DEBUG_LOGS: '{{ $isDebugLogsEnabled }}'
          ENABLE_EXPORTING_REPORTS: '{{ $isExportingEnabled }}'
    steps:
      - name: trigger_all
        type: {{ $stepType }}
        configuration:
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}

            # Enable trigger options via external resources
            {{ if $isExternalTriggerAvailable }}
            {{- range $resource := .Values.controls.triggerBy.externalResources }}
            - name: '{{ $resource.resourceName }}'
            {{- end }}
            {{ end }}

            # Enable cron trigger
            {{ if $isCronTriggerEnabled }}
            - name: {{ $cronResName }}
            {{ end }}

            # Enable incoming webhook triggers
            {{ if $isWebhookTriggerEnabled }}
            {{- range $webhook := .Values.controls.triggerBy.incomingWebhooks }}
            - name: "{{ $packageName }}_webhook_{{ $webhook.webhookName }}"
            {{ end }}
            {{ end }}
        execution:
          onExecute:
            - end_step success

      - name: frogbot_scan
        type: {{ $stepType }}
        configuration:
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          outputResources:
            - name: {{ $frogbotScanResName }}
          inputSteps:
            - name: trigger_all
        execution:
          onExecute:
            {{ template "step.frogbot.onExecute" $templateParams }}

      - name: code_quality
        type: {{ $stepType }}
        configuration:
          inputSteps:
            - name: trigger_all
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          outputResources:
            - name: {{ $codeQualityResName }}
        execution:
          onExecute:
            {{ template "step.codeQuality.onExecute" $templateParams }}

      - name: unit_tests
        type: {{ $stepType }}
        configuration:
          inputSteps:
            - name: trigger_all
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          outputResources:
            - name: {{ $unitTestResName }}
        execution:
          onExecute:
            {{ template "step.test.onExecute" $templateParams }}

      - name: lint
        type: {{ $stepType }}
        configuration:
          affinityGroup: build
          inputSteps:
            - name: trigger_all
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          outputResources:
            - name: {{ $buildInfoResultResName }}
        execution:
          onExecute:
            {{ template "step.lint.onExecute" $templateParams }}

      - name: build
        type: {{ $stepType }}
        configuration:
          affinityGroup: build
          inputSteps:
            - name: lint
              status:
                - success
          outputResources:
            - name: {{ $buildInfoResultResName }}
        execution:
          onExecute:
            {{ template "step.build.onExecute" $templateParams }}

      - name: publish
        type: {{ $stepType }}
        configuration:
          affinityGroup: build
          inputSteps:
            - name: frogbot_scan
              status:
                - success
            - name: build
              status:
                - success
            - name: unit_tests
              status:
                - success
            - name: code_quality
              status:
                - success
          outputResources:
            - name: {{ $buildInfoResultResName }}
            - name: {{ $buildInfoResName }}
        execution:
          onExecute:
            {{ template "step.publish.onExecute" $templateParams }}